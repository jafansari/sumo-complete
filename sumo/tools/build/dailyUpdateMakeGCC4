#!/bin/bash
MAKELOG=$HOME/DLR/sumomake.log
RUNLOG=$HOME/DLR/sumologs.tar.gz
MAKEALLLOG=$HOME/DLR/sumomakeall.log

cd $HOME/DLR/sumo
make distclean &> /dev/null
make -f Makefile.cvs clean &> /dev/null
svn up &> $MAKELOG || (echo "svn up failed"; tail -10 $MAKELOG)
make -f Makefile.cvs >> $MAKELOG 2>&1
./configure --with-fox-libraries=$HOME/DLR/lib --with-fox-includes=$HOME/DLR/include/fox-1.4 \
--with-gdal-libraries=$HOME/DLR/lib --with-gdal-includes=$HOME/DLR/include \
--with-proj-libraries=$HOME/DLR/lib --with-proj-includes=$HOME/DLR/include \
--prefix=$HOME/DLR >> $MAKELOG 2>&1
make dist >> $MAKELOG 2>&1 || (echo "make dist failed"; tail -10 $MAKELOG)
make >> $MAKELOG 2>&1 || (echo "make failed"; tail -20 $MAKELOG)
make install >> $MAKELOG 2>&1 || (echo "make install failed"; tail -10 $MAKELOG)
gzip -f $MAKELOG
scp -q $MAKELOG.gz shell.sf.net:sumo-www/

if test -e $HOME/DLR/bin/sumo; then
  # run tests
  export PATH=$HOME/DLR/texttest:$PATH
  tests/testDaily.sh $HOME/DLR/bin &> /dev/null
  scp -qr /tmp/sumo_report shell.sf.net:sumo-www/

  # run examples
  find data/examples -name "*.sumo.cfg" -exec src/sumo -c '{}' -l '{}'.log \; &> /dev/null
  find data/examples/ -newer $MAKELOG.gz -type f > /tmp/sumo_examples 2> /dev/null
  tar -czf $RUNLOG -T /tmp/sumo_examples --remove-files &> /dev/null
  scp -q $RUNLOG shell.sf.net:sumo-www/
fi

export CXXFLAGS="-Wall -Wextra -pedantic -Wno-long-long -g -O2"
#--with-xmlrpc=$HOME/DLR/xmlrpc++0.7
./configure --with-fox-libraries=$HOME/DLR/lib --with-fox-includes=$HOME/DLR/include/fox-1.4 \
--with-proj-gdal=$HOME/DLR --enable-double-precision \
--enable-geomcheck --enable-debug --enable-speedcheck --enable-memcheck &> $MAKEALLLOG
make clean all >> $MAKEALLLOG 2>&1 || (echo "make with all options failed"; tail -20 $MAKEALLLOG)
gzip -f $MAKEALLLOG
scp -q $MAKEALLLOG.gz shell.sf.net:sumo-www/

