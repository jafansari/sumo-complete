#!/bin/bash
if test "x$1" = "x"; then
  PREFIX=$HOME/DLR
else
  PREFIX=$1
fi
if test "x$2" = "x"; then
  FILEPREFIX=gcc4
else
  FILEPREFIX=$2
fi
if test "x$3" = "x"; then
  REMOTEDIR="shell.sf.net:sumo-www/"
else
  REMOTEDIR=$3
fi
MAKELOG=$PREFIX/${FILEPREFIX}make.log
RUNLOG=$PREFIX/${FILEPREFIX}examplelogs.tar.gz
MAKEALLLOG=$PREFIX/${FILEPREFIX}makealloptions.log
BATCH_RESULT_DIR=$PREFIX/${FILEPREFIX}batch_result
REPORT_DIR=$PREFIX/${FILEPREFIX}report

cd $PREFIX/sumo
make distclean &> /dev/null
make -f Makefile.cvs clean &> /dev/null
svn up &> $MAKELOG || (echo "svn up failed"; tail -10 $MAKELOG)
make -f Makefile.cvs >> $MAKELOG 2>&1 || (echo "autoreconf failed"; tail -10 $MAKELOG; exit)
./configure --with-gdal-libraries=$PREFIX/lib --with-gdal-includes=$PREFIX/include \
--with-proj-libraries=$PREFIX/lib --with-proj-includes=$PREFIX/include \
--prefix=$PREFIX >> $MAKELOG 2>&1 || (echo "configure failed"; tail -10 $MAKELOG; exit)
make dist >> $MAKELOG 2>&1 || (echo "make dist failed"; tail -10 $MAKELOG)
make >> $MAKELOG 2>&1 || (echo "make failed"; tail -20 $MAKELOG)
make install >> $MAKELOG 2>&1 || (echo "make install failed"; tail -10 $MAKELOG)
gzip -f $MAKELOG
scp -q $MAKELOG.gz $REMOTEDIR

if test -e $PREFIX/bin/sumo; then
  # run tests
  export PATH=$PREFIX/texttest:$PATH
  tests/testDaily.sh $PREFIX/bin $BATCH_RESULT_DIR $REPORT_DIR &> /dev/null
  scp -qr $REPORT_DIR $REMOTEDIR

  # run examples
  find data/examples -name "*.sumo.cfg" -exec src/sumo -c '{}' -l '{}'.log \; &> /dev/null
  find data/examples/ -newer $MAKELOG.gz -type f > /tmp/sumo_examples 2> /dev/null
  tar -czf $RUNLOG -T /tmp/sumo_examples --remove-files &> /dev/null
  scp -q $RUNLOG $REMOTEDIR
fi

export CXXFLAGS="-Wall -Wextra -pedantic -Wno-long-long -g -O2"
#--with-xmlrpc=$PREFIX/xmlrpc++0.7
./configure --with-fox-libraries=$PREFIX/lib --with-fox-includes=$PREFIX/include/fox-1.4 \
--with-proj-gdal=$PREFIX --enable-double-precision \
--enable-geomcheck --enable-debug --enable-speedcheck --enable-memcheck &> $MAKEALLLOG
make clean all >> $MAKEALLLOG 2>&1 || (echo "make with all options failed"; tail -20 $MAKEALLLOG)
gzip -f $MAKEALLLOG
scp -q $MAKEALLLOG.gz $REMOTEDIR

